<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SurveyJS Form Builder (pReact version)</title>

  <script src="./survey.core.js"></script>
  <script src="./survey.i18n.js"></script>
  <script src="./survey-js-ui.js"></script>
  <script src="./themes/index.js"></script>
  <script src="./creator-themes/index.js"></script>
  <script src="./survey-creator-core.js"></script>
  <script src="./survey-creator-core.i18n.js"></script>
  <script src="./survey-creator-js.js"></script>

  <link rel="stylesheet" href="./survey-core.css" />
  <link rel="stylesheet" href="./survey-creator-core.css" />
</head>

<body>
  <div id="surveyCreatorContainer" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;"></div>

<script>
  const LOCAL_STORAGE_KEY = "localSurveyJSON";
  const THEME_STORAGE_KEY = "localSurveyTheme";
  const SYNCED_FLAG_KEY = "localSurveySynced";

  let isSurveySaved = false;
  let isThemeSaved = false;

  SurveyCreatorCore.registerCreatorTheme(SurveyCreatorTheme);
  SurveyCreatorCore.registerSurveyTheme(SurveyTheme);

  const creator = new SurveyCreator.SurveyCreator({
    showThemeTab: true,
    showTranslationTab: true
  });

  creator.autoSaveEnabled = true;

  // Restore saved JSON
  const savedJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
  if (savedJSON) {
    try {
      creator.JSON = JSON.parse(savedJSON);
    } catch (e) {
      console.warn("Failed to parse saved JSON:", e);
    }
  }

  // Restore theme
  const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
  if (savedTheme) {
    try {
      creator.theme = JSON.parse(savedTheme);
    } catch (e) {
      console.warn("Failed to parse saved theme:", e);
    }
  }


  function markSyncedIfBothSaved() {
    if (isSurveySaved && isThemeSaved) {
      localStorage.setItem(SYNCED_FLAG_KEY, "true");
      console.log("Both survey and theme saved. Synced flag set.");
    } else {
      localStorage.setItem(SYNCED_FLAG_KEY, "false");
    }
  }

  creator.saveSurveyFunc = (saveNo, callback) => {
    try {
      const currentJSON = creator.JSON;
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentJSON));
      isSurveySaved = true;
      console.log("Survey saved.");
    } catch (e) {
      console.error("Failed to save survey JSON:", e);
      isSurveySaved = false;
    }
    markSyncedIfBothSaved();
    callback(saveNo, true);
  };

  creator.saveThemeFunc = (saveNo, callback) => {
    try {
      const currentTheme = creator.theme;
      localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(currentTheme));
      isThemeSaved = true;
      console.log("Theme saved.");
    } catch (e) {
      console.error("Failed to save theme:", e);
      isThemeSaved = false;
    }
    markSyncedIfBothSaved();
    callback(saveNo, true);
  };

  window.addEventListener("online", () => {
    const isSynced = localStorage.getItem(SYNCED_FLAG_KEY);
    const json = localStorage.getItem(LOCAL_STORAGE_KEY);
    const theme = localStorage.getItem(THEME_STORAGE_KEY);

    if (isSynced !== "true" && json && theme) {
      console.log("Syncing with server...");
      sendToServer(JSON.parse(json), theme);
    }
  });

  function sendToServer(surveyData, theme) {
    // Simulated async sync
    setTimeout(() => {
      console.log("Synced survey:", surveyData);
      console.log("Synced theme:", theme);
      localStorage.setItem(SYNCED_FLAG_KEY, "true");
    }, 1000);
  }

  creator.render("surveyCreatorContainer");
</script>


</body>
</html>
